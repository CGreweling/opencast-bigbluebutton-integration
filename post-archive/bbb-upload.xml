<?xml version="1.0" encoding="UTF-8" ?>
<definition xmlns="http://workflow.opencastproject.org">

  <id>bbb-upload</id>
  <title>BigBlueButton Upload</title>
  <tags>
    <tag>archive</tag>
  </tags>
  <displayOrder>1000</displayOrder>
  <description>
    Handles processing of raw recording data from BigBlueButton
  </description>

  <configuration_panel>
    <![CDATA[
      <div id="workflow-configuration">
        <input id="publish" name="publish" type="checkbox" class="configField" value="true" checked=checked />
        <label for="publish">Publish media directly</label>
      </div>
    ]]>
  </configuration_panel>

  <operations>

    <!-- Apply the default workflow configuration -->

    <operation
        id="defaults"
        description="Applying default configuration values">
      <configurations>
        <configuration key="flagForCutting">false</configuration>
        <configuration key="flagForReview">false</configuration>
        <configuration key="flagQuality360p">false</configuration>
        <configuration key="flagQuality480p">false</configuration>
        <configuration key="flagQuality720p">true</configuration>
        <configuration key="flagQuality1080p">true</configuration>
        <configuration key="flagQuality2160p">false</configuration>
        <configuration key="publishToEngage">true</configuration>
        <configuration key="thumbnailType">0</configuration>
        <configuration key="thumbnailPosition">1</configuration>
      </configurations>
    </operation>

    <!-- Apply ACL from series to the mediapackage -->

    <operation
        id="series"
        fail-on-error="true"
        exception-handler-workflow="partial-error"
        description="Applying access control entries from series">
      <configurations>
        <configuration key="apply-acl">true</configuration>
      </configurations>
    </operation>

    <!-- Save source in case of errors -->

    <operation
        id="tag"
        description="Tagging source material for archival">
      <configurations>
        <configuration key="source-flavors">*/*</configuration>
        <configuration key="target-tags">+archive</configuration>
      </configurations>
    </operation>

    <operation
        id="snapshot"
        fail-on-error="true"
        exception-handler-workflow="partial-error"
        description="Archiving">
      <configurations>
        <configuration key="source-tags">archive</configuration>
      </configurations>
    </operation>


    <!-- Combine files from BBB -->

    <operation
        id="inspect"
        fail-on-error="true"
        exception-handler-workflow="error"
        description="Inspecting mediapackage track elements">
      <configurations>
        <configuration key="overwrite">false</configuration>
        <configuration key="accept-no-media">false</configuration>
        <configuration key="accurate-frame-count">true</configuration>
      </configurations>
    </operation>

    <operation id="partial-import"
               description="Post-processing raw audio and video files from capture agent"
               fail-on-error="true"
               exception-handler-workflow="partial-error">
      <configurations>
        <configuration key="source-presenter-flavor">presenter/source</configuration>
        <configuration key="source-presentation-flavor">presentation/source</configuration>
        <configuration key="source-smil-flavor">smil/source+partial</configuration>
        <configuration key="target-presenter-flavor">presenter/prepared-partial</configuration>
        <configuration key="target-presentation-flavor">presentation/prepared-partial</configuration>
        <configuration key="concat-encoding-profile">concat.work</configuration>
        <configuration key="trim-encoding-profile">trim.work</configuration>
        <configuration key="force-encoding-profile">editor.work</configuration>
        <!-- Not yet in Opencast! -->
        <configuration key="preencode-encoding">true</configuration>
        <configuration key="preencode-encoding-profile">editor.work</configuration>
      </configurations>
    </operation>

    <operation
            id="encode"
            if="NOT ${presenter_source_video} AND ${presenter_source_audio}"
            exception-handler-workflow="partial-error"
            description="Encoding video from audio Stream">
      <configurations>
        <configuration key="source-flavor">presenter/prepared-partial</configuration>
        <configuration key="target-flavor">presenter/prepared</configuration>
        <configuration key="encoding-profile">audio-to-video</configuration>
     </configurations>
    </operation>

    <operation
            id="tag"
            if="${presenter_source_video} OR ${presentation_source_video}"
            fail-on-error="true"
            exception-handler-workflow="error"
            description="Tagging media package elements">
      <configurations>
        <configuration key="source-flavors">*/prepared-partial</configuration>
        <configuration key="target-flavor">*/prepared</configuration>
        <configuration key="copy">false</configuration>
      </configurations>
    </operation>


    <!-- Create preview artifacts -->
    <operation
        id="include"
        description="Prepare preview versions of the recording">
      <configurations>
        <configuration key="workflow-id">bbb-partial-preview</configuration>
      </configurations>
    </operation>

    <!-- Publish -->
    <operation
        id="include"
        description="Publish the recording">
      <configurations>
        <configuration key="workflow-id">bbb-partial-publish</configuration>
      </configurations>
    </operation>

    <!-- Archive the final state of the media package -->
    <operation
        id="export-wf-properties"
        fail-on-error="false"
        description="Export workflow settings to Java properties file">
      <configurations>
        <configuration key="target-flavor">processing/defaults</configuration>
        <configuration key="target-tags">archive</configuration>
      </configurations>
    </operation>

    <operation
        id="tag"
        description="Untagging source material for archival removal">
      <configurations>
        <configuration key="source-flavors">*/source</configuration>
        <configuration key="target-tags">-archive</configuration>
      </configurations>
    </operation>

    <operation
        id="tag"
        description="Tagging work material for archival">
      <configurations>
        <configuration key="source-flavors">*/prepared</configuration>
        <configuration key="target-tags">+archive</configuration>
      </configurations>
    </operation>

    <operation
        id="snapshot"
        fail-on-error="true"
        exception-handler-workflow="partial-error"
        description="Archiving">
      <configurations>
        <configuration key="source-tags">archive</configuration>
      </configurations>
    </operation>

    <!-- Delete every but the last snapshot -->
    <!-- <operation
        id="asset-delete"
        fail-on-error="true"
        exception-handler-workflow="partial-error"
        description="Delete every older Snapshot from AssetManager">
      <configurations>
        <configuration key="keep-last-snapshot">true</configuration>
      </configurations>
    </operation> -->

    <!-- Clean up the working file repository -->

    <operation
        id="cleanup"
        fail-on-error="false"
        description="Cleaning up">
      <configurations>
        <configuration key="delete-external">true</configuration>
        <!-- FixMe Don't clean up ACLs until workflow service no longer looks for them in the WFR. -->
        <configuration key="preserve-flavors">security/*</configuration>
      </configurations>
    </operation>

  </operations>

</definition>

